buildscript {
  repositories {
    gradlePluginPortal()
    mavenCentral()
    google()
    maven { url 'https://repo.gradle.org/gradle/repo' }
    maven { url uri("../repo") }
  }
  dependencies {
  }
}

apply plugin: 'com.android.application'
apply plugin: 'kotlin-android'
apply plugin: 'kotlin-kapt'
apply plugin: 'kotlin-parcelize'
apply plugin: 'androidx.navigation.safeargs.kotlin'
apply plugin: 'dagger.hilt.android.plugin'

def makeVersion = { String endSuffix ->
  def suffix = ''

  if (endSuffix != null) {
    suffix += "-$endSuffix"
  }
  def builtVersionName = "2.0.0"
  def useAutoGenerated = true

  if (useAutoGenerated) {
    builtVersionName += suffix
  }

  builtVersionName
}

android {
  compileSdkVersion project.compileSdkVersion
  buildToolsVersion project.buildToolsVersion

  namespace 'com.test.project'

  defaultConfig {
    applicationId 'com.test.project'
    minSdkVersion project.minSdkVersion
    targetSdkVersion project.targetSdkVersion

    buildFeatures {
      vectorDrawables.useSupportLibrary = true
      multiDexEnabled true
    }

    testInstrumentationRunnerArguments clearPackageData: 'true'
    testInstrumentationRunner 'androidx.test.runner.AndroidJUnitRunner'
  }

  flavorDimensions "default"

  productFlavors {
    qa {
      dimension "default"
      minSdkVersion project.minSdkVersion

      versionCode 1264 + gitVersioner.versionCode
      versionName makeVersion('qa')
    }

    v23 {
      dimension "default"
      minSdkVersion project.minSdkVersion

      versionCode 1264 + gitVersioner.versionCode
      versionName makeVersion()
    }
  }

  bundle {
    density {
      // Different APKs are generated for devices with different screen densities; true by default.
      enableSplit true
    }
    abi {
      // Different APKs are generated for devices with different CPU architectures; true by default.
      enableSplit true
    }
    language {
      // This is disabled so that the App Bundle does NOT split the APK for each language.
      // We're gonna use the same APK for all languages.
      enableSplit false
    }
  }

  buildTypes {
    debug {
      zipAlignEnabled true
      aaptOptions.cruncherEnabled = false
      ext.alwaysUpdateBuildId = false

      // due to https://www.techyourchance.com/disable-firebase-crashlytics-in-android-debug-builds/
      manifestPlaceholders = [crashlyticsCollectionEnabled: 'true']
      ext.enableCrashlytics = true
    }

    release {
      minifyEnabled true
      shrinkResources true
      proguardFile getDefaultProguardFile('proguard-android.txt')
      proguardFiles fileTree(dir: '../tools/proguard/release', include: ['*.pro']).
              asList().
              toArray()

      // due to https://www.techyourchance.com/disable-firebase-crashlytics-in-android-debug-builds/
      manifestPlaceholders = [crashlyticsCollectionEnabled: 'true']
      ext.enableCrashlytics = true
    }
  }

  testOptions {
    unitTests.returnDefaultValues = true
    execution 'ANDROIDX_TEST_ORCHESTRATOR'
    unitTests.all {
      useJUnitPlatform()
    }
  }

  compileOptions {
    sourceCompatibility JavaVersion.VERSION_11
    targetCompatibility JavaVersion.VERSION_11
  }

  kotlinOptions {
    jvmTarget = JavaVersion.VERSION_11
  }

  buildFeatures {
    viewBinding true
    compose true
  }

  composeOptions {
    kotlinCompilerExtensionVersion rootProject.ext.composeVersion
    // Remove kotlinCompilerVersion from here
  }

  hilt {
    enableAggregatingTask = true
  }

  kapt {
    correctErrorTypes = true
    useBuildCache = true

    arguments {
      arg("dagger.formatGeneratedSource", "disabled")
    }
  }

  lint {
    abortOnError true
    checkDependencies true
    warningsAsErrors false

    setLintConfig(file("../tools/lint-rules.xml"))
    baseline file("lint-baseline.xml")
  }
  sourceSets {
    test.java.srcDirs += 'src/test/java'
  }

  android.variantFilter { variant ->
    // Loop flavors
    variant.getFlavors().each { flavor ->
      if (variant.buildType.name == 'debug' && flavor.name == 'v23') {
        variant.setIgnore(true)
      }
      if (variant.buildType.name == 'release' && flavor.name == 'qa') {
        variant.setIgnore(true)
      }
    }
  }

  applicationVariants.all { variant ->
    variant.outputs.all { output ->
      if (outputFileName.endsWith('.apk')) {
        def apkName = "Test-Project"
        if (variant.buildType.name == 'release') {
          apkName += '-v' + variant.versionName + '-release.apk'
        } else {
          apkName += "-${variant.versionName}-(${variant.versionCode}).apk"
        }
        outputFileName = apkName
      }
    }
  }
}

dependencies {
  implementation 'androidx.activity:activity-compose:1.7.0'

  // Compose
  implementation "androidx.compose.compiler:compiler:$rootProject.ext.composeVersion"
  implementation "androidx.compose.ui:ui:1.4.1"
  implementation "androidx.compose.ui:ui-tooling:1.4.1"
  implementation "androidx.compose.animation:animation:1.4.1"
  implementation "androidx.compose.material:material:1.4.1"
  implementation "androidx.compose.foundation:foundation:1.4.1"
  implementation "androidx.compose.runtime:runtime:1.4.1"
  implementation "androidx.compose.material3:material3:1.0.1"

  implementation "com.google.accompanist:accompanist-systemuicontroller:0.30.1"
  implementation "com.google.accompanist:accompanist-placeholder:0.30.1"
  implementation "com.google.accompanist:accompanist-drawablepainter:0.30.1"
  implementation "com.google.accompanist:accompanist-adaptive:0.30.1"

  implementation "io.coil-kt:coil-compose:2.2.2"
  implementation "androidx.compose.material:material-icons-extended:1.4.1"
  implementation "androidx.palette:palette-ktx:1.0.0"

  implementation "androidx.media3:media3-exoplayer:1.0.0"
  implementation "androidx.media3:media3-exoplayer-dash:1.0.0"
  implementation "androidx.media3:media3-ui:1.0.0"

  implementation "com.google.dagger:dagger:$daggerVersion"
  kapt "com.google.dagger:dagger-compiler:$daggerVersion"
  kaptTest "com.google.dagger:dagger-compiler:$daggerVersion"

  implementation "com.google.dagger:hilt-android:$daggerVersion"
  kapt "com.google.dagger:hilt-compiler:$daggerVersion"

  // For local unit tests
  testImplementation "com.google.dagger:hilt-android:$daggerVersion"
  kaptTest "com.google.dagger:hilt-compiler:$daggerVersion"

  implementation "com.squareup.moshi:moshi:$moshiVersion"
  implementation "com.squareup.moshi:moshi-kotlin:$moshiVersion"
  implementation "com.squareup.retrofit2:converter-moshi:$retrofitVersion"
  kapt "com.squareup.moshi:moshi-kotlin-codegen:$moshiVersion"

  // Retrofit
  implementation "com.squareup.retrofit2:retrofit:$retrofitVersion"

  // OkHttp
  implementation "com.squareup.okhttp3:okhttp:$okHttpVersion"
  implementation "com.squareup.okhttp3:logging-interceptor:$okHttpVersion"

  // Coroutines
  implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-android:1.6.4'

  // ViewModel and LiveData
  implementation "androidx.lifecycle:lifecycle-common-java8:$lifecycleVersion"
  implementation "androidx.lifecycle:lifecycle-livedata-ktx:$lifecycleVersion"

  // Timber
  implementation 'com.jakewharton.timber:timber:5.0.1'

  // Kotlin
  implementation "org.jetbrains.kotlin:kotlin-stdlib:$kotlinVersion"

  // Kotlin extensions
  implementation "androidx.core:core-ktx:1.10.0"
  implementation "androidx.navigation:navigation-fragment-ktx:$navVersion"
  implementation "androidx.navigation:navigation-ui-ktx:$navVersion"
  implementation "androidx.navigation:navigation-compose:$navVersion"
  implementation 'androidx.fragment:fragment-ktx:1.5.6'
  implementation "androidx.window:window:1.0.0"

  // Flipper
  debugImplementation 'com.facebook.flipper:flipper:0.189.0'
  debugImplementation 'com.facebook.soloader:soloader:0.10.5'
  debugImplementation 'com.facebook.flipper:flipper-network-plugin:0.189.0'
  releaseImplementation 'com.facebook.flipper:flipper-noop:0.189.0'

  // testing
  testImplementation "org.jetbrains.kotlinx:kotlinx-coroutines-test:1.6.4"
  testImplementation 'org.jetbrains.kotlin:kotlin-stdlib:' + kotlinVersion
  testImplementation 'org.jetbrains.kotlin:kotlin-test-junit:' + kotlinVersion

  testImplementation 'com.nhaarman:mockito-kotlin:1.6.0'
  //assertions
  testImplementation 'org.assertj:assertj-core:3.24.2'

  testImplementation 'app.cash.turbine:turbine:0.12.3'
  testImplementation "org.mockito.kotlin:mockito-kotlin:4.1.0"
  testImplementation 'org.mockito:mockito-junit-jupiter:5.2.0'
  testImplementation 'org.junit.jupiter:junit-jupiter-api:5.9.2'
  testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.9.2'
  testImplementation 'org.junit.jupiter:junit-jupiter-params:5.9.2'
  testRuntimeOnly 'org.junit.vintage:junit-vintage-engine:5.9.2'
}
